<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متجر — تفاصيل</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="header">عشارك — عرض المتجر</div>
  <div class="container" id="container">

    <div id="storeArea"></div>

    <div id="productsArea"></div>

  </div>

  <!-- مودال الطلب -->
  <div id="orderModal" class="modal">
    <div class="dialog">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>تأكيد الطلب</strong>
        <span class="close-x" onclick="closeOrderModal()">×</span>
      </div>
      <div id="orderBody" style="margin-top:12px"></div>
      <div style="margin-top:12px;text-align:left">
        <button class="btn" onclick="confirmOrder()">إرسال الطلب</button>
      </div>
    </div>
  </div>

<script>
/* helpers */
function uid(pref='id'){ return pref + '_' + Date.now() + '_' + Math.floor(Math.random()*900+100) }
function save(key,val){ localStorage.setItem(key, JSON.stringify(val)) }
function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback }catch(e){ return fallback } }

/* load store by id from query */
const stores = load('stores', []);
const orders = load('orders', []);
function qParam(name){
  const ps = new URLSearchParams(location.search);
  return ps.get(name);
}
const storeId = qParam('id');
const store = stores.find(s=>s.id === storeId);

const container = document.getElementById('container');

if(!store){
  container.innerHTML = '<div class="card"><p>المتجر غير موجود أو تم حذفه.</p><p><a href="index.html">العودة إلى المتاجر</a></p></div>';
} else {
  renderStore();
  renderProducts();
}

/* render store header */
function renderStore(){
  const html = `
    <div class="card store-header">
      <div class="store-avatar"><img src="${store.coverImage || ''}" alt=""></div>
      <div class="store-info">
        <h2>${store.name}</h2>
        <div class="owner">المالك: ${store.owner || '-' } • ${store.phone || '-'}</div>
        <div class="small" style="margin-top:8px">${store.address || ''}</div>
        <div style="margin-top:10px"><button class="btn" onclick="callOwner()">اتصل بالمالك</button> <button class="btn ghost" onclick="openAdmin()">لوحة الأدمن</button></div>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><h3>عن المتجر</h3><p class="small">${store.description || ''}</p></div>
  `;
  document.getElementById('storeArea').innerHTML = html;
}

/* render products */
function renderProducts(){
  const area = document.getElementById('productsArea');
  if(!store.products || !store.products.length){ area.innerHTML = '<div class="card small">لا توجد منتجات في هذا المتجر بعد.</div>'; return;}
  let html = '<h3>المنتجات</h3><div class="products">';
  store.products.forEach(p=>{
    html += `
      <div class="product">
        <img src="${p.image || ''}" alt="">
        <div class="pname">${p.name}</div>
        <div class="small">${p.description || ''}</div>
        <div class="price">${p.price} د.ع</div>
        <div style="margin-top:8px"><button class="btn" onclick="openOrderModal('${p.id}')">اطلب الآن</button></div>
      </div>
    `;
  });
  html += '</div>';
  area.innerHTML = html;
}

/* actions */
function callOwner(){ if(store.phone) window.open('tel:'+store.phone) }
function openAdmin(){ window.location.href='admin.html' }

/* order modal */
let currentProduct = null;
function openOrderModal(pid){
  currentProduct = store.products.find(x=>x.id === pid);
  const body = document.getElementById('orderBody');
  body.innerHTML = `
    <div><strong>${currentProduct.name}</strong></div>
    <div class="small">${currentProduct.description || ''}</div>
    <label>الكمية</label><input id="ordQty" type="number" value="1" min="1" />
    <label>اللون</label><select id="ordColor"></select>
    <label>التغليف</label><select id="ordWrap"></select>
    <label>اسم المشتري</label><input id="ordName" type="text" />
    <label>رقم الهاتف</label><input id="ordPhone" type="text" />
    <div style="margin-top:8px" class="small">السعر للوحدة: <strong>${currentProduct.price} د.ع</strong></div>
  `;

  // fill colors
  const colorSel = document.getElementById('ordColor');
  (currentProduct.colors||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; colorSel.appendChild(o); });
  // fills wraps from settings if exist
  const settings = load('settings', {wraps:[]});
  const wrapSel = document.getElementById('ordWrap');
  (settings.wraps||[]).forEach(w=>{ const o=document.createElement('option'); o.value=w.name; o.textContent=`${w.name} (+${w.price} د.ع)`; wrapSel.appendChild(o); });

  document.getElementById('orderModal').style.display = 'flex';
}
function closeOrderModal(){ document.getElementById('orderModal').style.display = 'none'; currentProduct=null; }

/* confirm order and save */
function confirmOrder(){
  const qty = Number(document.getElementById('ordQty').value) || 1;
  const color = document.getElementById('ordColor').value || '';
  const wrap = document.getElementById('ordWrap').value || '';
  const name = (document.getElementById('ordName').value || '').trim();
  const phone = (document.getElementById('ordPhone').value || '').trim();
  if(!name || !phone){ alert('أدخل الاسم ورقم الهاتف'); return; }
  const settings = load('settings', {wraps:[]});
  const wrapPrice = (settings.wraps || []).find(w=>w.name === wrap)?.price || 0;
  const total = Number(currentProduct.price) * qty + wrapPrice;
  const ord = {
    id: uid('order'),
    storeId: store.id,
    productId: currentProduct.id,
    productName: currentProduct.name,
    qty, color, wrap, totalPrice: total,
    customerName: name, customerPhone: phone,
    status:'new',
    createdAt: Date.now(),
    time: new Date().toLocaleString()
  };
  const ordersArr = load('orders', []);
  ordersArr.push(ord);
  save('orders', ordersArr);
  alert('تم إرسال الطلب بنجاح ✅');
  closeOrderModal();
}

/* init: try to fill wraps list if empty */
(function initDefaults(){
  const s = load('settings', null);
  if(!s){
    const defaults = {wraps:[{name:'تغليف بسيط',price:2000},{name:'تغليف فاخر',price:5000}], currency:'د.ع'};
    save('settings', defaults);
  }
})();
</script>
</body>
</html>
